<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>HMATB - Dragon Radar</title>

    <!-- Memuat Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha26-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Memuat Font Orbitron untuk tema radar/sci-fi -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Reset & Global Styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
        }

        /* Map Container */
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Header Utama */
        .main-header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: rgba(13, 17, 23, 0.8);
            padding: 8px 20px;
            border-radius: 30px;
            border: 1px solid #f6ad55;
            box-shadow: 0 0 15px rgba(246, 173, 85, 0.5);
        }
        .main-header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #f6ad55;
            text-shadow: 0 0 5px #f6ad55;
        }

        /* Panel Kontrol Progres */
        #progress-panel {
            position: absolute;
            top: 70px;
            right: 10px;
            width: 280px;
            background-color: rgba(13, 17, 23, 0.85);
            border: 1px solid #8b949e;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        #progress-panel h2 {
            margin: 0;
            padding: 10px;
            font-size: 1em;
            text-align: center;
            border-bottom: 1px solid #8b949e;
            color: #f0f6fc;
        }
        #db-list {
            list-style: none;
            padding: 10px;
            margin: 0;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .db-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        .db-item.active {
            opacity: 1;
            background-color: rgba(229, 62, 62, 0.3); /* Merah untuk target aktif */
            font-weight: bold;
        }
        .db-item.found {
            opacity: 1;
            background-color: rgba(63, 185, 80, 0.3);
            text-decoration: line-through;
        }

        /* Tombol Kontrol Bawah */
        #bottom-controls {
            position: absolute;
            bottom: 20px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .control-btn {
            background-color: #21262d;
            border: 1px solid #8b949e;
            color: #f0f6fc;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-btn:hover {
            background-color: #f6ad55;
            color: #0d1117;
            border-color: #f6ad55;
        }
        .control-btn.stop {
            background-color: #e53e3e;
        }

        /* Kustomisasi Pop-up Leaflet */
        .leaflet-popup-content-wrapper {
            background-color: #161b22;
            color: #c9d1d9;
            border: 1px solid #f6ad55;
        }
        .leaflet-popup-tip { background-color: #161b22; }
        .popup-title { color: #f6ad55; font-weight: bold; margin-bottom: 10px; }
        .claim-button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #f6ad55;
            color: #0d1117;
            border: none;
            border-radius: 5px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
        }
        .claim-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* Pesan Notifikasi 5 Detik */
        #notification-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none; /* Diubah oleh JS */
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        #notification-message {
            background-color: #21262d;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #f6ad55;
            font-size: 1.2em;
            color: #f0f6fc;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <h1>üêâ DRAGON RADAR</h1>
    </header>

    <div id="map"></div>

    <aside id="progress-panel">
        <h2>STATUS PENCARIAN</h2>
        <ul id="db-list">
            <!-- Daftar Dragon Ball akan di-generate oleh JavaScript -->
        </ul>
    </aside>

    <div id="bottom-controls">
        <button id="start-stop-btn" class="control-btn">üöÄ Mulai</button>
        <button id="recenter-btn" class="control-btn">üìç Pusatkan</button>
        <button id="reset-btn" class="control-btn">üè≥Ô∏è Menyerah!</button>
    </div>

    <div id="notification-overlay">
        <div id="notification-message"></div>
    </div>

    <script>
        // ==================================================================
        // KONFIGURASI PERMAINAN (LOKASI ITB GANESHA)
        // ==================================================================
        const initialConfig = {
            GEOFENCE_RADIUS_METERS: 15,
            mapCenter: { lat: -6.8917, lng: 107.6106 },
            dragonBalls: [
                { pos: { lat: -6.891402, lng: 107.609867 }, title: "Dragon Ball 1", claimed: false, revealed: false },
                { pos: { lat: -6.890317, lng: 107.611938 }, title: "Dragon Ball 2", claimed: false, revealed: false },
                { pos: { lat: -6.889568, lng: 107.609993 }, title: "Dragon Ball 3", claimed: false, revealed: false },
                { pos: { lat: -6.889638, lng: 107.608863 }, title: "Dragon Ball 4", claimed: false, revealed: false },
                { pos: { lat: -6.888278, lng: 107.610829 }, title: "Dragon Ball 5", claimed: false, revealed: false },
                { pos: { lat: -6.888294, lng: 107.610043 }, title: "Dragon Ball 6", claimed: false, revealed: false },
                { pos: { lat: -6.889397, lng: 107.610726 }, title: "Dragon Ball 7", claimed: false, revealed: false }
            ]
        };
        // ==================================================================

        let CONFIG;
        let map, userMarker, userLatLng, watchId = null;
        let dbListItems = [], activeMarkers = {};

        // --- FUNGSI UTAMA ---
        function initApp() {
            loadState();
            initUI();
            initMap();
            setupEventListeners();
        }

        function initUI() {
            const dbList = document.getElementById('db-list');
            dbList.innerHTML = ''; // Kosongkan dulu
            dbListItems = [];
            CONFIG.dragonBalls.forEach((db, index) => {
                const li = document.createElement('li');
                li.id = `db-item-${index}`;
                li.className = 'db-item';
                li.textContent = db.title;
                dbList.appendChild(li);
                dbListItems.push(li);
            });
            updateUI();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([CONFIG.mapCenter.lat, CONFIG.mapCenter.lng], 18);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 20
            }).addTo(map);
        }

        // --- LOGIKA PELACAKAN & GEOLOKASI ---
        function startLocationTracking() {
            if (watchId) return; // Mencegah duplikasi
            
            showNotification("selamat berpetualang!");

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                    if (!userMarker) {
                        const userIcon = L.divIcon({
                            html: '<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px #4285F4;"></div>',
                            className: 'user-marker', iconSize: [20, 20], iconAnchor: [10, 10]
                        });
                        userMarker = L.marker(userLatLng, { icon: userIcon }).addTo(map);
                        map.setView(userLatLng, 18); // Pusatkan peta saat lokasi pertama kali ditemukan
                    } else {
                        userMarker.setLatLng(userLatLng);
                    }
                    checkGeofence();
                    validateClaimButtons();
                },
                () => { alert("Error: Gagal mendapatkan lokasi."); stopLocationTracking(); },
                { enableHighAccuracy: true }
            );
            const btn = document.getElementById('start-stop-btn');
            btn.textContent = 'üõë Hentikan';
            btn.classList.add('stop');
        }

        function stopLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                const btn = document.getElementById('start-stop-btn');
                btn.textContent = 'üöÄ Mulai';
                btn.classList.remove('stop');
            }
        }

        // --- LOGIKA PERMAINAN OTOMATIS ---
        function checkGeofence() {
            if (!userLatLng) return;
            const nextBallIndex = CONFIG.dragonBalls.findIndex(db => !db.revealed);
            if (nextBallIndex === -1) return;

            const ball = CONFIG.dragonBalls[nextBallIndex];
            const ballLatLng = L.latLng(ball.pos.lat, ball.pos.lng);
            const distance = userLatLng.distanceTo(ballLatLng);

            console.log(`Jarak ke Dragon Ball #${nextBallIndex + 1} (tersembunyi): ${distance.toFixed(2)} meter`);

            if (distance <= CONFIG.GEOFENCE_RADIUS_METERS) {
                revealDragonBall(nextBallIndex);
            }
        }

        function revealDragonBall(index) {
            const ball = CONFIG.dragonBalls[index];
            if (ball.revealed) return;
            ball.revealed = true;
            saveState();

            const ballLatLng = L.latLng(ball.pos.lat, ball.pos.lng);
            const dbIcon = L.divIcon({
                html: `<div style="background-color: #e53e3e; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display:flex; justify-content:center; align-items:center; font-weight:bold; color:white;">${index + 1}</div>`,
                className: 'db-marker', iconSize: [28, 28], iconAnchor: [14, 14]
            });

            const marker = L.marker(ballLatLng, { icon: dbIcon }).addTo(map);
            const popupContent = `<div class="popup-title">${ball.title} TERDETEKSI!</div><button id="claim-btn-${index}" class="claim-button" disabled>Bola Diterima</button>`;
            marker.bindPopup(popupContent, { closeOnClick: false, autoClose: false }).openPopup();
            
            marker.getPopup().on('add', () => {
                document.getElementById(`claim-btn-${index}`).addEventListener('click', () => handleClaim(index));
            });

            activeMarkers[index] = marker;
            updateUI();
        }

        // --- LOGIKA KLAIM & VALIDASI ---
        function validateClaimButtons() {
            if (!userLatLng) return;
            for (const index in activeMarkers) {
                const ball = CONFIG.dragonBalls[index];
                if (!ball.claimed) {
                    const ballLatLng = L.latLng(ball.pos.lat, ball.pos.lng);
                    const distance = userLatLng.distanceTo(ballLatLng);
                    const claimButton = document.getElementById(`claim-btn-${index}`);
                    if (claimButton) {
                        claimButton.disabled = distance > CONFIG.GEOFENCE_RADIUS_METERS;
                    }
                }
            }
        }

        function handleClaim(index) {
            const ball = CONFIG.dragonBalls[index];
            ball.claimed = true;
            saveState();
            
            const marker = activeMarkers[index];
            marker.closePopup();
            map.removeLayer(marker);
            delete activeMarkers[index];
            
            const foundIcon = L.divIcon({
                html: `<div style="background-color: #3fb950; width: 20px; height: 20px; border-radius: 50%; border: 1px solid black;"></div>`,
                className: 'found-marker', iconSize: [22, 22], iconAnchor: [11, 11]
            });
            L.marker([ball.pos.lat, ball.pos.lng], { icon: foundIcon }).addTo(map);

            updateUI();
            showNotification("Janlup foto bersama setiap penemuan dragon ball dan video vlog selama petualangan berlangsung untuk sebagai bukti kelayakan kalian!");
        }

        // --- MANAJEMEN STATE & UI ---
        function saveState() {
            localStorage.setItem('dragonRadarState', JSON.stringify(CONFIG.dragonBalls));
        }

        function loadState() {
            const savedState = localStorage.getItem('dragonRadarState');
            if (savedState) {
                CONFIG = { ...initialConfig, dragonBalls: JSON.parse(savedState) };
            } else {
                CONFIG = JSON.parse(JSON.stringify(initialConfig)); // Deep copy
            }
        }

        function resetAdventure() {
            if (confirm("Apakah Anda yakin ingin menyerah dan mereset semua progres petualangan?")) {
                stopLocationTracking();
                localStorage.removeItem('dragonRadarState');
                
                // PERUBAHAN: Tampilkan notifikasi sebelum me-reload halaman
                showNotification("Loss, sayonara!");
                
                // Tunggu 5 detik agar notifikasi terbaca, lalu reload
                setTimeout(() => {
                    location.reload();
                }, 5000);
            }
        }

        function updateUI() {
            dbListItems.forEach((item, index) => {
                item.className = 'db-item';
                if (CONFIG.dragonBalls[index].claimed) {
                    item.classList.add('found');
                } else if (CONFIG.dragonBalls[index].revealed) {
                    item.classList.add('active');
                }
            });
        }

        function showNotification(message) {
            const overlay = document.getElementById('notification-overlay');
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = message;
            overlay.style.display = 'flex';
            setTimeout(() => { overlay.style.display = 'none'; }, 5000);
        }

        function setupEventListeners() {
            document.getElementById('start-stop-btn').addEventListener('click', () => {
                if (watchId) {
                    stopLocationTracking();
                } else {
                    startLocationTracking();
                }
            });
            document.getElementById('recenter-btn').addEventListener('click', () => {
                if (userMarker) {
                    map.setView(userMarker.getLatLng(), 18);
                } else {
                    alert("Lokasi belum ditemukan. Klik 'Mulai' untuk memulai pelacakan.");
                }
            });
            document.getElementById('reset-btn').addEventListener('click', resetAdventure);
        }
        
        // Inisialisasi Aplikasi
        initApp();
        console.log("Aplikasi Dragon Radar siap.");
    </script>
</body>
</html>
