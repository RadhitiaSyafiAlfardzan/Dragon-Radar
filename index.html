<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>HME ITB - Dragon Radar</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Font Orbitron (tema sci-fi) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    /* ---------- Global ---------- */
    :root{
      --bg: #0d1117;
      --panel: rgba(13,17,23,0.85);
      --accent: #f6ad55;
      --muted: #8b949e;
      --light: #f0f6fc;
      --red: #e5534b;
      --green: #3fb950;
      --map-dark: #0b0d0f;
    }
    html,body{height:100%;margin:0;padding:0;font-family:'Orbitron',sans-serif;background:var(--bg);color:var(--light);overflow:hidden}
    #map{position:absolute;top:0;left:0;right:0;bottom:0;z-index:1}

    /* ---------- Header ---------- */
    .main-header{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1100;background:rgba(13,17,23,0.9);padding:8px 22px;border-radius:28px;border:1px solid var(--accent);box-shadow:0 0 18px rgba(246,173,85,0.25)}
    .main-header h1{margin:0;font-size:1.2rem;color:var(--accent);text-shadow:0 0 8px rgba(246,173,85,0.25)}

    /* ---------- Panel Status (kanan) ---------- */
    #progress-panel{position:absolute;right:12px;top:70px;width:320px;background:var(--panel);border:1px solid var(--muted);border-radius:10px;padding:0;z-index:1100;backdrop-filter:blur(4px)}
    #progress-panel h2{margin:0;padding:12px;font-size:0.95rem;text-align:center;border-bottom:1px solid var(--muted);color:var(--light);letter-spacing:1px}
    #db-list{list-style:none;padding:10px;margin:0;max-height:calc(100vh - 220px);overflow:auto}
    .db-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin-bottom:8px;background:transparent;opacity:0.85}
    .db-item .left{display:flex;flex-direction:column}
    .db-item .title{font-weight:700;color:var(--light)}
    .db-item .sub{font-size:0.8rem;opacity:0.75;color:#cbd5e1}
    .db-item .dist{font-weight:700;color:#dbe7f8}
    .db-item.active{background:rgba(229,62,62,0.08)}
    .db-item.found{background:rgba(63,185,80,0.08);text-decoration:line-through}

    /* ---------- Bottom Controls ---------- */
    #bottom-controls{position:absolute;left:10px;right:10px;bottom:16px;display:flex;justify-content:space-between;align-items:center;gap:12px;z-index:1100}
    .control-left, .control-center, .control-right{display:flex;align-items:center;gap:12px}
    .control-btn{background:#21262d;border:1px solid var(--muted);color:var(--light);padding:10px 18px;border-radius:28px;font-family:'Orbitron',sans-serif;cursor:pointer;transition:all .15s ease}
    .control-btn:hover{background:var(--accent);color:var(--bg);border-color:var(--accent)}
    .control-btn.stop{background:var(--red);color:#fff}
    .center-button{margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:8px}
    .gps-card{background:rgba(22,27,34,0.9);padding:8px 14px;border-radius:12px;border:1px solid var(--muted);font-size:0.92rem;box-shadow:0 4px 14px rgba(0,0,0,0.5)}

    /* ---------- Final Boss Panel ---------- */
    #final-panel{position:absolute;left:50%;transform:translateX(-50%);bottom:90px;z-index:1101;background:rgba(13,17,23,0.95);border:1px solid var(--accent);padding:12px;border-radius:12px;min-width:340px;display:none;backdrop-filter:blur(6px);box-shadow:0 0 18px rgba(246,173,85,0.2)}
    #final-panel h3{margin:0 0 8px 0;color:var(--accent);text-align:center}
    #final-panel .final-row{display:flex;gap:8px}
    #final-panel input{flex:1;background:var(--bg);border:1px solid var(--muted);border-radius:8px;padding:10px 12px;color:var(--light)}
    #final-panel button{background:var(--accent);border:none;border-radius:8px;padding:10px 12px;font-weight:700;cursor:pointer;color:var(--bg)}

    /* ---------- Toast & Center message ---------- */
    #notification-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200}
    #notification-message{background:rgba(22,27,34,0.98);padding:18px;border-radius:10px;border:1px solid var(--muted);color:var(--light);font-size:1rem;min-width:260px;text-align:center}
    #notification-overlay.toast-success #notification-message{border-color:var(--green);box-shadow:0 0 18px rgba(63,185,80,0.18)}
    #notification-overlay.toast-error #notification-message{border-color:var(--red);box-shadow:0 0 18px rgba(229,83,75,0.18)}
    #notification-overlay.toast-warn #notification-message{border-color:var(--accent);box-shadow:0 0 18px rgba(246,173,85,0.18)}

    /* Center info message (5 detik after claim) */
    #center-info{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1250;display:none;pointer-events:none}
    #center-info .card{background:rgba(22,27,34,0.96);padding:18px;border-radius:12px;border:1px solid var(--muted);min-width:300px;text-align:center;color:var(--light);font-size:1.05rem}

    /* ---------- Modal Claim ---------- */
    #claim-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1300;background:rgba(0,0,0,0.55)}
    .claim-card{background:rgba(13,17,23,0.98);padding:14px;border-radius:12px;border:1px solid var(--muted);min-width:320px;max-width:90%;color:var(--light)}
    .claim-card h4{margin:0 0 10px 0;color:var(--accent)}
    .claim-list{max-height:320px;overflow:auto;margin:6px 0 10px 0}
    .claim-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
    .claim-row .meta{display:flex;flex-direction:column}
    .claim-row button{background:var(--accent);border:none;border-radius:8px;padding:8px 10px;color:var(--bg);cursor:pointer}
    .claim-row button.disabled{background:#444;color:#aaa;cursor:not-allowed}

    /* ---------- Marker styles & pulse animation ---------- */
    .db-marker-el{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #fff;font-weight:700;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.6)}
    .db-marker-el.num{background:#e53e3e}
    .db-found-el{width:22px;height:22px;border-radius:50%;background:var(--green);border:1px solid #0b0b0b}
    /* pulse ring */
    .pulse-ring{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:52px;height:52px;border-radius:50%;pointer-events:none;opacity:0.9}
    .pulse-ring::after{content:'';position:absolute;inset:0;border-radius:50%;box-shadow:0 0 0 2px rgba(229,62,62,0.25)}
    .pulse-anim{animation:pulse 1.6s infinite ease-out}
    @keyframes pulse{
      0%{transform:translate(-50%,-50%) scale(0.6);opacity:0.8}
      70%{transform:translate(-50%,-50%) scale(1.6);opacity:0}
      100%{opacity:0}
    }

    /* ---------- Victory Screen (baru) ---------- */
    #victory-screen{
      position:fixed; inset:0; display:none;
      z-index:2000;                           /* di atas semuanya */
      background: radial-gradient(1200px 600px at 50% -10%, rgba(246,173,85,0.2), rgba(0,0,0,0.9)),
                  rgba(0,0,0,0.92);
      backdrop-filter: blur(2px);
      align-items:center; justify-content:center; flex-direction:column;
      text-align:center; color:var(--light);
      padding:20px;
    }
    #victory-title{font-size:2rem; margin:0 0 10px 0; color:var(--accent); text-shadow:0 0 16px rgba(246,173,85,0.35)}
    #victory-sub{font-size:1.1rem; margin:0 0 14px 0; opacity:0.95}
    #victory-img{max-width:min(86vw,620px); max-height:min(60vh,520px); border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,0.55); border:1px solid rgba(255,255,255,0.08); margin-bottom:14px}
    .victory-row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
    .victory-btn{
      background:#21262d; color:#fff; border:1px solid var(--muted);
      padding:10px 16px; border-radius:12px; cursor:pointer; font-family:'Orbitron',sans-serif;
    }
    .victory-btn:hover{ background:var(--accent); color:var(--bg); border-color:var(--accent) }
    #sound-hint{ font-size:0.86rem; opacity:0.85; margin-top:8px }

    /* small responsive */
    @media (max-width:720px){
      #progress-panel{width:260px;right:8px;top:60px}
      #final-panel{min-width:280px}
      #victory-title{font-size:1.6rem}
      #victory-sub{font-size:1rem}
    }
  </style>
</head>
<body>
  <header class="main-header"><h1>üêâ DRAGON RADAR</h1></header>

  <div id="map"></div>

  <aside id="progress-panel">
    <h2>STATUS PENCARIAN</h2>
    <ul id="db-list"></ul>
  </aside>

  <div id="bottom-controls">
    <div class="control-left">
      <button id="start-stop-btn" class="control-btn">üöÄ Mulai</button>
    </div>

    <div class="control-center center-button">
      <div id="gps-card" class="gps-card">GPS: ‚Äî</div>
      <button id="center-btn" class="control-btn">‚Ä¢ Pusatkan</button>
      <button id="claim-open-btn" class="control-btn" title="Tekan jika sudah menerima kode dari panitia">üéØ Bola Diterima</button>
    </div>

    <div class="control-right" style="justify-self:end">
      <button id="reset-btn" class="control-btn">üè≥Ô∏è Menyerah!</button>
    </div>
  </div>

  <!-- Final Boss Panel -->
  <div id="final-panel">
    <h3>‚öîÔ∏è FINAL BOSS ‚Äî PLN</h3>
    <div class="final-row">
      <input id="final-code" type="text" placeholder="Masukkan kode final (4‚Äì6 huruf)" maxlength="6" inputmode="latin" />
      <button id="final-claim-btn">CLAIM</button>
    </div>
    <div style="margin-top:8px;font-size:0.83rem;opacity:0.9">Harus berada di radius lokasi final & 6 bola sudah terklaim.</div>
  </div>

  <!-- Modal klaim -->
  <div id="claim-modal" aria-hidden="true">
    <div class="claim-card" role="dialog" aria-modal="true">
      <h4>Klaim Bola ‚Äî Pilih lokasi</h4>
      <div id="claim-list" class="claim-list"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="claim-close" class="control-btn">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Toast & Center info -->
  <div id="notification-overlay"><div id="notification-message"></div></div>
  <div id="center-info"><div class="card" id="center-info-card"></div></div>

 <!-- ===== Victory Screen (baru) ===== -->
<div id="victory-screen" role="dialog" aria-modal="true" aria-hidden="true">
  <h2 id="victory-title">SELAMAT YE! üéâ</h2>
  <p id="victory-sub">DEJAHIM TERCYNTAH!</p>
  <img id="victory-img" src="meme dejahim.jpg" alt="Meme kemenangan: Dejahim Tercyntah" />
  <!-- Audio disembunyikan, diputar via JS setelah klaim final -->
  <audio id="victory-audio"
         src="different-heaven-safe-and-sound-[ncs-release]-made-with-Voicemod.mp3"
         preload="auto"
         loop></audio>
  <div class="victory-row" style="margin-top:6px">
    <button id="victory-sound-btn" class="victory-btn">üîä Putar Musik</button>
    <button id="victory-restart-btn" class="victory-btn">üîÑ Restart</button>
    <button id="victory-close-btn" class="victory-btn">‚úñÔ∏è Tutup</button>
  </div>
  <div id="sound-hint">Jika musik belum terdengar, tekan <b>Putar Musik</b>.</div>
</div>


  <script>
    /******************************************************************
     * Dragon Radar - Perbaikan klaim kapan saja (asalkan kode valid)
     * + Victory screen (musik + meme) saat final boss berhasil
     ******************************************************************/

    // ---------------------- KONFIGURASI ----------------------
    const initialConfig = {
      GEOFENCE_RADIUS_METERS: 15, // radius geofence otomatis (meter)
      mapCenter: { lat: -6.8917, lng: 107.6106 }, // default center (ITB)
      dragonBalls: [
        { pos: { lat: -6.891402262078686, lng: 107.60986788020188 }, title: 'Dragon Ball 1', code: 'KAMEH', claimed: false, revealed: false, ts: null },
        { pos: { lat: -6.890317257283004, lng: 107.61193810855009 }, title: 'Dragon Ball 2', code: 'SENZU', claimed: false, revealed: false, ts: null },
        { pos: { lat: -6.8895688198770255, lng: 107.60999326735156 }, title: 'Dragon Ball 3', code: 'NIMBU', claimed: false, revealed: false, ts: null },
        { pos: { lat: -6.889638867816123, lng: 107.6088639094271 }, title: 'Dragon Ball 4', code: 'AETHER', claimed: false, revealed: false, ts: null },
        { pos: { lat: -6.888278359981987, lng: 107.61082908926849 }, title: 'Dragon Ball 5', code: 'TURBO', claimed: false, revealed: false, ts: null },
        { pos: { lat: -6.888294319040551, lng: 107.61004341921445 }, title: 'Dragon Ball 6', code: 'SPARK', claimed: false, revealed: false, ts: null },
        { pos: { lat: -6.889397475056475, lng: 107.61072630941614 }, title: 'Dragon Ball 7 (FINAL)', code: 'ZENOS', claimed: false, revealed: false, ts: null }
      ]
    };

    // ---------------------- STATE VAR ----------------------
    let CONFIG;
    let map, userMarker, userLatLng = null, watchId = null;
    let dbListItems = [];             // DOM list items
    let activeMarkers = {};           // marker saat revealed (red)
    let foundMarkers = {};            // green markers bila claimed
    let isClaiming = false;           // lock anti double click
    let pulseNearestIdx = null;       // index marker yang dipulse

    // ---------------------- UTILS ----------------------
    function getDistanceBetween(lat1, lon1, lat2, lon2){
      // Haversine -> hasil dalam meter
      const R = 6371000; // earth radius m
      const toRad = a => a * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function prettyDistance(m){
      if (m === null || m === undefined || isNaN(m)) return '‚Äî';
      if (m < 1000) return `${Math.round(m)} m`;
      return `${(m/1000).toFixed(2)} km`;
    }

    function saveState(){
      try{
        localStorage.setItem('dragonRadarState', JSON.stringify(CONFIG.dragonBalls));
      }catch(e){ console.warn('saveState error', e) }
    }

    function loadState(){
      const saved = localStorage.getItem('dragonRadarState');
      if(saved){
        try{
          const savedBalls = JSON.parse(saved);
          // merge supaya field baru tetap ada
          CONFIG = JSON.parse(JSON.stringify(initialConfig));
          CONFIG.dragonBalls = initialConfig.dragonBalls.map((db, idx) => ({ ...db, ...(savedBalls[idx]||{}) }));
          return;
        }catch(e){
          console.warn('loadState parse error', e);
        }
      }
      CONFIG = JSON.parse(JSON.stringify(initialConfig));
    }

    // ---------------------- INIT APP ----------------------
    function initApp(){
      loadState();
      initMap();
      initUI();
      rebuildMarkersFromState();
      setupEventListeners();
      updateFinalBossUI();
    }

    // ---------------------- MAP & MARKERS ----------------------
    function initMap(){
      map = L.map('map', { zoomControl:true }).setView([CONFIG.mapCenter.lat, CONFIG.mapCenter.lng], 16);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom:20
      }).addTo(map);
    }

    function createActiveMarker(index){
      // buat marker "terdeteksi" (merah dengan nomor) ‚Äî hanya untuk revealed tapi belum claimed
      const ball = CONFIG.dragonBalls[index];
      // jika sudah ada, skip
      if(activeMarkers[index] || foundMarkers[index]) return;

      const html = `<div class="db-marker-el num" data-idx="${index}">${index+1}</div>`;
      const icon = L.divIcon({ html, className: 'db-marker-wrap', iconSize:[28,28], iconAnchor:[14,14] });
      const marker = L.marker([ball.pos.lat, ball.pos.lng], { icon }).addTo(map);

      // popup kecil ‚Äî non-intrusive
      const popupHtml = `<div style="color:#f0f6fc;font-weight:700">${ball.title} TERDETEKSI!</div><div style="font-size:0.85rem;color:#cbd5e1">Tekan "Bola Diterima" untuk klaim jika panitia sudah verifikasi kode.</div>`;
      marker.bindPopup(popupHtml, { closeOnClick:false, autoClose:false });

      activeMarkers[index] = marker;
      try{ marker.openPopup(); setTimeout(()=>marker.closePopup(), 2500); }catch(e){}
      return marker;
    }

    function removeActiveMarker(index){
      const m = activeMarkers[index];
      if(m){ try{ map.removeLayer(m); }catch(e){} delete activeMarkers[index]; }
    }

    function createFoundMarker(index){
      // buat marker hijau (claimed)
      if(foundMarkers[index]) return;
      const ball = CONFIG.dragonBalls[index];
      const icon = L.divIcon({ html:'<div class="db-found-el"></div>', className:'db-found-wrap', iconSize:[22,22], iconAnchor:[11,11] });
      const marker = L.marker([ball.pos.lat, ball.pos.lng], { icon }).addTo(map);
      const popup = `<div style="font-weight:bold;color:#0b0b0b">${ball.title} ‚Äî TERKLAIM</div><div style="font-size:0.85rem;color:#07260f">Waktu: ${ball.ts?new Date(ball.ts).toLocaleString():'‚Äî'}</div>`;
      marker.bindPopup(popup);
      foundMarkers[index] = marker;
      try{ marker.openPopup(); setTimeout(()=>marker.closePopup(),2000); }catch(e){}
    }

    function rebuildMarkersFromState(){
      // hapus semua dulu
      Object.keys(activeMarkers).forEach(k=>{ try{ map.removeLayer(activeMarkers[k]) }catch(e){} })
      Object.keys(foundMarkers).forEach(k=>{ try{ map.removeLayer(foundMarkers[k]) }catch(e){} })
      activeMarkers = {}; foundMarkers = {};

      CONFIG.dragonBalls.forEach((db, idx) => {
        if(db.claimed){
          createFoundMarker(idx);
        } else if(db.revealed && idx < 6){
          createActiveMarker(idx);
        }
      });
    }

    // ---------------------- UI (list, gps card) ----------------------
    function initUI(){
      // buat list item placeholders
      const list = document.getElementById('db-list');
      list.innerHTML = '';
      dbListItems = [];
      CONFIG.dragonBalls.forEach((db, idx) => {
        const li = document.createElement('li');
        li.id = `db-item-${idx}`;
        li.className = 'db-item';
        li.innerHTML = `<div class="left"><div class="title">${db.title}</div><div class="sub" id="db-sub-${idx}">${db.claimed ? 'Terklaim' : (db.revealed ? 'Terdeteksi' : 'Tersembunyi')}</div></div><div class="dist" id="db-dist-${idx}">‚Äî</div>`;
        list.appendChild(li);
        dbListItems.push(li);
      });
      updateUI(); // refresh distances dll.
    }

    function updateUI(){
      // update each list item: status, waktu, distance
      dbListItems.forEach((li, idx) => {
        const db = CONFIG.dragonBalls[idx];
        const sub = li.querySelector(`#db-sub-${idx}`);
        const distEl = li.querySelector(`#db-dist-${idx}`);
        if(db.claimed) {
          li.classList.add('found'); li.classList.remove('active');
          sub.textContent = 'Terklaim';
        } else if (db.revealed){
          li.classList.add('active'); li.classList.remove('found');
          sub.textContent = 'Terdeteksi';
        } else {
          li.classList.remove('active'); li.classList.remove('found');
          sub.textContent = 'Tersembunyi';
        }

        // jarak
        if(userLatLng){
          const m = getDistanceBetween(userLatLng.lat, userLatLng.lng, db.pos.lat, db.pos.lng);
          distEl.textContent = prettyDistance(m);
          distEl.title = `${m.toFixed(1)} m`;
        } else {
          distEl.textContent = '‚Äî';
        }
      });
    }

    // ---------------------- GEO TRACKING ----------------------
    function startLocationTracking(){
      if(watchId) return;
      showToast('Selamat berpetualang!', 'success', 5000);

      if(!('geolocation' in navigator)){
        alert('Perangkat Anda tidak mendukung geolocation.');
        return;
      }

      watchId = navigator.geolocation.watchPosition(position => {
        const { latitude, longitude, accuracy } = position.coords;
        userLatLng = L.latLng(latitude, longitude);

        // update user marker
        if(!userMarker){
          const html = '<div style="background:#4285F4;width:16px;height:16px;border-radius:50%;border:2px solid white;box-shadow:0 0 10px #4285F4"></div>';
          const icon = L.divIcon({ html, className:'user-marker', iconSize:[20,20], iconAnchor:[10,10] });
          userMarker = L.marker(userLatLng, { icon }).addTo(map);
          map.setView(userLatLng, 16);
        } else {
          userMarker.setLatLng(userLatLng);
        }

        // update gps card
        const gpsCard = document.getElementById('gps-card');
        gpsCard.textContent = `GPS ¬±${Math.round(accuracy)} m ‚Äî Lat:${latitude.toFixed(6)}, Lng:${longitude.toFixed(6)}`;
        if(accuracy > 50) gpsCard.style.borderColor = 'var(--red)';
        else if (accuracy > 20) gpsCard.style.borderColor = 'var(--accent)';
        else gpsCard.style.borderColor = 'var(--green)';
        gpsCard.style.display = 'block';

        // cek geofence & update distances + pulsing
        checkGeofence();
        updateUI();
        updatePulseNearest();

      }, err => {
        console.error('watchPosition error', err);
        alert('Error: gagal mendapatkan lokasi. Pastikan izin lokasi diberikan dan tidak ada overlay yang memblokir.');
        stopLocationTracking();
      }, { enableHighAccuracy: true, maximumAge:1000, timeout:10000 });

      document.getElementById('start-stop-btn').textContent = '‚è∏ Hentikan';
      document.getElementById('start-stop-btn').classList.add('stop');
    }

    function stopLocationTracking(){
      if(watchId){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      document.getElementById('start-stop-btn').textContent = 'üöÄ Mulai';
      document.getElementById('start-stop-btn').classList.remove('stop');
      document.getElementById('gps-card').style.display = 'none';
    }

    // ---------------------- GEOFENCE & REVEAL ----------------------
    function checkGeofence(){
      if(!userLatLng) return;
      // hanya auto-reveal 1..6 (index < 6)
      CONFIG.dragonBalls.forEach((ball, idx) => {
        if(idx >= 6) return; // final tidak auto-reveal
        if(ball.claimed) return;
        const dist = getDistanceBetween(userLatLng.lat, userLatLng.lng, ball.pos.lat, ball.pos.lng);
        if(dist <= CONFIG.GEOFENCE_RADIUS_METERS && !ball.revealed){
          ball.revealed = true;
          saveState();
          createActiveMarker(idx);
          showToast(`${ball.title} terdeteksi di sekitarmu!`, 'warn', 3000);
        }
      });
      saveState();
    }

    // ---------------------- PULSE MARKER TERDEKAT ----------------------
    function updatePulseNearest(){
      if(!userLatLng) return;
      // cari nearest unclaimed (0..6)
      let nearestIdx = null, nearestDist = Infinity;
      CONFIG.dragonBalls.forEach((ball, idx) => {
        if(ball.claimed) return;
        const d = getDistanceBetween(userLatLng.lat, userLatLng.lng, ball.pos.lat, ball.pos.lng);
        if(d < nearestDist){ nearestDist = d; nearestIdx = idx; }
      });

      // atur pulsing class
      if(pulseNearestIdx !== null && pulseNearestIdx !== nearestIdx){
        // hapus pulse dari yang lama
        const oldMarker = activeMarkers[pulseNearestIdx] || foundMarkers[pulseNearestIdx];
        if(oldMarker && oldMarker.getElement){
          const el = oldMarker.getElement();
          if(el) {
            const ring = el.querySelector('.pulse-ring');
            if(ring) ring.classList.remove('pulse-anim');
          }
        }
        pulseNearestIdx = null;
      }

      if(nearestIdx !== null){
        const marker = activeMarkers[nearestIdx] || foundMarkers[nearestIdx];
        if(marker && marker.getElement){
          const el = marker.getElement();
          if(el){
            // jika belum ada pulse ring, buat
            let ring = el.querySelector('.pulse-ring');
            if(!ring){
              ring = document.createElement('div'); ring.className = 'pulse-ring';
              el.style.position = 'relative';
              el.appendChild(ring);
            }
            // aktifkan animasi
            ring.classList.add('pulse-anim');
            pulseNearestIdx = nearestIdx;
          }
        }
      }
    }

    // ---------------------- KLAIM FLOW (modal) ----------------------
    function openClaimModal(){
      const modal = document.getElementById('claim-modal');
      const list = document.getElementById('claim-list');
      list.innerHTML = '';

      CONFIG.dragonBalls.forEach((ball, idx) => {
        const dist = userLatLng ? getDistanceBetween(userLatLng.lat, userLatLng.lng, ball.pos.lat, ball.pos.lng) : null;
        const row = document.createElement('div'); row.className = 'claim-row';
        const meta = document.createElement('div'); meta.className = 'meta';
        const title = document.createElement('div'); title.textContent = ball.title; title.style.fontWeight='700';
        const sub = document.createElement('div'); sub.textContent = `${ball.claimed? 'Sudah terklaim' : (ball.revealed ? 'Terdeteksi' : 'Tersembunyi')} ‚Ä¢ ${dist? prettyDistance(dist) : '‚Äî'}`; sub.style.fontSize='0.85rem'; sub.style.opacity='0.9';
        meta.appendChild(title); meta.appendChild(sub);

        const btn = document.createElement('button');
        btn.textContent = ball.claimed? 'Terklaim' : 'Klaim';

        // ===== PERUBAHAN PENTING =====
        // Sebelumnya klaim dibatasi jarak; sekarang klaim boleh kapan saja
        // asalkan user memasukkan kode yang benar.
        if(ball.claimed){
          btn.classList.add('disabled'); btn.disabled = true;
        } else {
          // tombol aktif ‚Äî user dapat memasukkan kode kapan saja
          btn.addEventListener('click', () => {
            const code = prompt(`Masukkan kode validasi untuk ${ball.title} (4‚Äì6 huruf):`);
            if(code === null) return;
            if(code.trim().toUpperCase() !== ball.code){
              showToast('‚ùå Kode salah! Jangan asal ngetik, kami mengawasi!.', 'error', 5000);
              return;
            }
            // lakukan klaim tanpa pengecekan jarak
            finalizeClaim(idx);
            closeClaimModal();
          });
        }

        row.appendChild(meta); row.appendChild(btn);
        list.appendChild(row);
      });

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function closeClaimModal(){
      const modal = document.getElementById('claim-modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    function finalizeClaim(index){
      if(isClaiming) return;
      const ball = CONFIG.dragonBalls[index];
      if(!ball || ball.claimed) { showToast('Sudah terklaim atau tidak ditemukan.', 'warn'); return; }

      isClaiming = true;
      // tandai klaim
      ball.claimed = true;
      ball.ts = Date.now();
      // jika belum revealed, set revealed true supaya marker aktif diganti
      ball.revealed = true;
      saveState();

      // bersihkan active marker
      removeActiveMarker(index);
      // buat found marker hijau
      createFoundMarker(index);
      updateUI();

      // Center map ke lokasi klaim sedikit (opsional)
      try{ map.setView([ball.pos.lat, ball.pos.lng], 17, { animate:true }); }catch(e){}

      // pesan tengah 5 detik (instruksi vlog/foto)
      showCenterInfo('Jangan lupa lanjutkan video vlog dan foto tiap pos dragon ball yak!', 8000);

      // toast sukses
      showToast('‚úÖ Bola berhasil diklaim! Selamat!', 'success', 5000);
      isClaiming = false;

      // cek final boss
      if(allFirstSixClaimed() && !CONFIG.dragonBalls[6].claimed){
        showToast('‚öîÔ∏è 6 bola terkumpul! Final Boss terbuka.', 'success', 5000);
        updateFinalBossUI();
      }
    }

    // ---------------------- FINAL BOSS ----------------------
    function updateFinalBossUI(){
      const panel = document.getElementById('final-panel');
      if(allFirstSixClaimed() && !CONFIG.dragonBalls[6].claimed){
        panel.style.display = 'block';
      } else {
        panel.style.display = 'none';
      }
    }

    document.getElementById('final-claim-btn').addEventListener('click', () => {
      const code = (document.getElementById('final-code').value || '').trim().toUpperCase();
      const finalIdx = 6;
      const finalBall = CONFIG.dragonBalls[finalIdx];
      if(!allFirstSixClaimed()){ showToast('Kumpulkan 6 bola dulu!', 'warn'); return; }
      if(code.length < 4 || code !== finalBall.code){ showToast('‚ùå Kode final salah.', 'error'); return; }

      // Klaim final (tidak pakai cek jarak juga)
      finalBall.revealed = true;
      finalBall.claimed = true;
      finalBall.ts = Date.now();
      saveState();
      if(!foundMarkers[finalIdx]) createFoundMarker(finalIdx);
      updateUI(); updateFinalBossUI();
      showCenterInfo('üéâ SEMUA DRAGON BALL TERKUMPUL! Shenron dipanggil!', 4000);
      showToast('üéâ Final berhasil diklaim!', 'success', 4000);

      // ===== TAMPILKAN VICTORY SCREEN + PUTAR MUSIK =====
      showVictoryScreen();
    });

    // panitia shortcut di console
    window.claimFinalBall = function claimFinalBall(){
      const i = 6;
      CONFIG.dragonBalls[i].revealed = true; CONFIG.dragonBalls[i].claimed = true; CONFIG.dragonBalls[i].ts = Date.now();
      saveState();
      if(!foundMarkers[i]) createFoundMarker(i);
      updateUI(); updateFinalBossUI();
      showToast('‚ö° Final Ball diklaim oleh panitia (override).', 'warn', 3000);

      // pastikan victory screen juga muncul via override
      showVictoryScreen();
    };

    function allFirstSixClaimed(){
      return CONFIG.dragonBalls.slice(0,6).every(b => b.claimed);
    }

    // ---------------------- TOAST & CENTER MSG ----------------------
    function showToast(message, type='info', dur=1600){
      const overlay = document.getElementById('notification-overlay');
      const msg = document.getElementById('notification-message');
      overlay.className = ''; overlay.style.display = 'flex';
      overlay.classList.remove('toast-success','toast-error','toast-warn');
      if(type==='success') overlay.classList.add('toast-success');
      if(type==='error') overlay.classList.add('toast-error');
      if(type==='warn') overlay.classList.add('toast-warn');
      msg.textContent = message;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{ overlay.style.display='none'; }, dur);
    }

    function showCenterInfo(message, dur=5000){
      const card = document.getElementById('center-info-card');
      const wrap = document.getElementById('center-info');
      card.textContent = message;
      wrap.style.display = 'block';
      clearTimeout(showCenterInfo._t);
      showCenterInfo._t = setTimeout(()=>{ wrap.style.display = 'none'; }, dur);
    }

    // ---------------------- Victory helpers (BARU) ----------------------
    function showVictoryScreen(){
      const scr = document.getElementById('victory-screen');
      scr.style.display = 'flex';
      scr.setAttribute('aria-hidden','false');

      // Coba autoplay (akan sukses jika dipicu gesture tombol CLAIM)
      tryPlayVictoryAudio();
    }

    function hideVictoryScreen(){
      const scr = document.getElementById('victory-screen');
      scr.style.display = 'none';
      scr.setAttribute('aria-hidden','true');
      stopVictoryAudio();
    }

    function tryPlayVictoryAudio(){
      const audio = document.getElementById('victory-audio');
      if(!audio) return;
      audio.currentTime = 0;
      const p = audio.play();
      if(p && typeof p.catch === 'function'){
        p.catch(()=> {
          // Autoplay diblok ‚Äî tampilkan hint
          document.getElementById('sound-hint').style.opacity = '1';
        });
      }
    }

    function stopVictoryAudio(){
      const audio = document.getElementById('victory-audio');
      if(audio && !audio.paused){
        try{ audio.pause(); }catch(e){}
      }
    }

    function restartGame(){
      stopVictoryAudio();
      localStorage.removeItem('dragonRadarState');
      location.reload();
    }

    // ---------------------- Reset adventure ----------------------
    function resetAdventure(){
      if(!confirm('Apakah Anda yakin ingin menyerah dan mereset semua progres petualangan?')) return;
      stopLocationTracking();
      localStorage.removeItem('dragonRadarState');
      // reload state dan tampilkan pesan singkat
      showToast('Loss, sayonara!', 'warn', 3000);
      setTimeout(()=> location.reload(), 1200);
    }

    // ---------------------- SETUP EVENT LISTENERS ----------------------
    function setupEventListeners(){
      document.getElementById('start-stop-btn').addEventListener('click', ()=>{
        if(watchId) stopLocationTracking(); else startLocationTracking();
      });
      document.getElementById('center-btn').addEventListener('click', ()=>{
        if(userMarker) map.setView(userMarker.getLatLng(), 17, { animate:true });
        else showToast("Lokasi belum ditemukan. Klik 'Mulai' untuk memulai pelacakan.", 'warn', 2000);
      });
      document.getElementById('claim-open-btn').addEventListener('click', openClaimModal);
      document.getElementById('claim-close').addEventListener('click', closeClaimModal);
      document.getElementById('reset-btn').addEventListener('click', resetAdventure);

      // Victory buttons
      document.getElementById('victory-restart-btn').addEventListener('click', restartGame);
      document.getElementById('victory-close-btn').addEventListener('click', hideVictoryScreen);
      document.getElementById('victory-sound-btn').addEventListener('click', tryPlayVictoryAudio);

      // close modal on ESC
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeClaimModal(); });
    }

    // ---------------------- START ----------------------
    initApp();
    console.log('Aplikasi Dragon Radar siap.');

    // update UI distances regularly even when geolocation not running
    setInterval(()=>{
      updateUI();
      updatePulseNearest();
    }, 1500);

  </script>
</body>
</html>
